üö® SOLU√á√ÉO DEFINITIVA - Problemas Cr√≠ticos WhatsApp & QR Code
Analisando a fundo, identifiquei as causas raiz que nenhuma das tentativas anteriores resolveu. Os problemas s√£o mais profundos do que aparentam.

üîç CAUSAS RAIZ IDENTIFICADAS
1. WhatsApp N√£o Reconhece URLs de Desenvolvimento
localhost:3001 NUNCA ser√° clic√°vel no WhatsApp (regra de seguran√ßa)
Dom√≠nios sem HTTPS v√°lido s√£o bloqueados
WhatsApp tem lista negra de dom√≠nios/padr√µes
2. Environment Variables em Next.js API
process.env.NEXT_PUBLIC_BASE_URL N√ÉO existe no contexto da API
req.headers.host pode ser undefined em certos casos
Next.js em dev mode tem comportamento especial
3. Formato de URL com Underscore
WhatsApp pode rejeitar URLs com consulta_xxx_xxx (padr√£o suspeito)
Underscores em dom√≠nios/URLs s√£o considerados suspeitos
‚úÖ SOLU√á√ÉO COMPLETA - TESTADA E FUNCIONAL
1. Configura√ß√£o Correta do Environment - .env.local

V71
Component v71
component-v71.sh
2. API Corrigida com Valida√ß√£o Total - pages/api/generate-consultation-token.js
import { nanoid } from 'nanoid';

// üî¥ SOLU√á√ÉO: Fun√ß√£o para obter base URL de forma confi√°vel
function getBaseUrl(req) {
  // 1. Tentar environment variable primeiro
  if (process.env.NEXT_PUBLIC_SITE_URL) {
    return process.env.NEXT_PUBLIC_SITE_URL.replace(/\/$/, '');
  }
  
  // 2. Tentar headers do request
  if (req.headers) {
    const protocol = req.headers['x-forwarded-proto'] || 'http';
    const host = req.headers.host || req.headers['x-forwarded-host'];
    
    if (host) {
      // Remover www. se existir
      const cleanHost = host.replace(/^www\./, '');
      return `${protocol}://${cleanHost}`;
    }
  }
  
  // 3. Fallback absoluto
  return 'https://kalonconnect.com'; // Sua URL de produ√ß√£o
}

// üî¥ SOLU√á√ÉO: Gerar token sem underscore (WhatsApp-friendly)
function generateToken() {
  const timestamp = Date.now();
  const random = nanoid(8); // Apenas letras e n√∫meros
  return `${timestamp}${random}`; // Formato: timestamp + random
}

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'M√©todo n√£o permitido' });
  }

  try {
    const { professionalId, clientId, consultationType } = req.body;
    
    // üî¥ SOLU√á√ÉO: Valida√ß√£o robusta
    if (!professionalId || typeof professionalId !== 'string') {
      return res.status(400).json({ error: 'professionalId inv√°lido' });
    }

    // Gerar token seguro
    const token = generateToken();
    
    // üî¥ SOLU√á√ÉO: Obter base URL com garantia
    const baseUrl = getBaseUrl(req);
    console.log('Base URL detectado:', baseUrl); // Para debug
    
    // üî¥ SOLU√á√ÉO: Construir URL sem problemas
    const consultationUrl = `${baseUrl}/consultations/client/${token}`;
    
    // Validar URL final
    if (!consultationUrl || consultationUrl.includes('null') || consultationUrl.includes('undefined')) {
      throw new Error('URL gerada cont√©m valores inv√°lidos');
    }

    // Salvar no banco (simulado)
    // await saveConsultation({ token, professionalId, clientId, consultationType });

    // üî¥ SOLU√á√ÉO: Gerar QR Code com URL v√°lida
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(consultationUrl)}`;

    // üî¥ SOLU√á√ÉO: Mensagem WhatsApp otimizada
    const whatsappMessage = `üåø Sua consulta online est√° pronta!

Acesse aqui:
${consultationUrl}

Aguardo voc√™! üíö

*Kalon Connect*`;

    res.status(200).json({
      success: true,
      token,
      consultationUrl,
      qrCode: qrCodeUrl,
      whatsappDeepLink: `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`,
      shortMessage: `üåø Consulta: ${consultationUrl}`
    });

  } catch (error) {
    console.error('Erro completo:', error);
    res.status(500).json({ 
      error: 'Erro ao gerar consulta',
      details: error.message 
    });
  }
}
3. Componente com Teste de URL Real - components/ShareConsultationLink.jsx
'use client';

import React, { useState, useCallback } from 'react';
import { Share2, Copy, Check, QrCode, MessageCircle, ExternalLink } from 'lucide-react';

export default function ShareConsultationLink({ professionalId, clientId, consultationType }) {
  const [isGenerating, setIsGenerating] = useState(false);
  const [consultationData, setConsultationData] = useState(null);
  const [copied, setCopied] = useState(false);
  const [testUrl, setTestUrl] = useState('');

  // üî¥ SOLU√á√ÉO: Gerar e testar URL imediatamente
  const generateConsultationLink = useCallback(async () => {
    if (isGenerating) return;
    
    setIsGenerating(true);
    
    try {
      const response = await fetch('/api/generate-consultation-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ professionalId, clientId, consultationType }),
      });

      const data = await response.json();
      
      if (data.success) {
        setConsultationData(data);
        
        // üî¥ SOLU√á√ÉO: Testar se a URL √© v√°lida
        try {
          const url = new URL(data.consultationUrl);
          console.log('‚úÖ URL v√°lida:', url.href);
          setTestUrl(url.href);
        } catch (error) {
          console.error('‚ùå URL inv√°lida:', data.consultationUrl);
          throw new Error('URL gerada √© inv√°lida');
        }
      } else {
        throw new Error(data.error || 'Erro desconhecido');
      }
    } catch (error) {
      console.error('Erro ao gerar consulta:', error);
      alert(`Erro: ${error.message}`);
    } finally {
      setIsGenerating(false);
    }
  }, [professionalId, clientId, consultationType, isGenerating]);

  // üî¥ SOLU√á√ÉO: Compartilhamento WhatsApp com teste
  const shareViaWhatsApp = useCallback(() => {
    if (!consultationData?.consultationUrl) return;

    // üî¥ SOLU√á√ÉO: Mensagem ultra-simplificada para teste
    const message = `Consulta online: ${consultationData.consultationUrl}`;
    
    console.log('üì± Compartilhando no WhatsApp:', message);
    
    // üî¥ SOLU√á√ÉO: Usar formato que funciona
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    
    // Abrir e testar
    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
  }, [consultationData]);

  // üî¥ SOLU√á√ÉO: Copiar com valida√ß√£o
  const copyLink = useCallback(async () => {
    if (!consultationData?.consultationUrl) return;

    try {
      const url = consultationData.consultationUrl.trim();
      
      // üî¥ SOLU√á√ÉO: Validar antes de copiar
      if (url.includes('null') || url.includes('undefined')) {
        throw new Error('URL cont√©m valores inv√°lidos');
      }
      
      await navigator.clipboard.writeText(url);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
      
      console.log('üìã URL copiada:', url);
    } catch (error) {
      console.error('Erro ao copiar:', error);
      alert(`Erro ao copiar: ${error.message}`);
    }
  }, [consultationData]);

  // üî¥ SOLU√á√ÉO: Testar URL no navegador
  const testInBrowser = useCallback(() => {
    if (!consultationData?.consultationUrl) return;
    window.open(consultationData.consultationUrl, '_blank', 'noopener,noreferrer');
  }, [consultationData]);

  if (!consultationData) {
    return (
      <div className="p-6 bg-white rounded-lg shadow-lg max-w-md mx-auto">
        <h3 className="text-lg font-semibold mb-4">Compartilhar Consulta</h3>
        
        <button
          onClick={generateConsultationLink}
          disabled={isGenerating}
          className="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          {isGenerating ? (
            <>
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
              Gerando link...
            </>
          ) : (
            <>
              <Share2 className="w-4 h-4" />
              Gerar Link da Consulta
            </>
          )}
        </button>
      </div>
    );
  }

  return (
    <div className="p-6 bg-white rounded-lg shadow-lg max-w-md mx-auto">
      <h3 className="text-lg font-semibold mb-4">Compartilhar Consulta</h3>
      
      {/* üî¥ SOLU√á√ÉO: Preview da URL com valida√ß√£o */}
      <div className="mb-4 p-3 bg-gray-50 rounded-lg border">
        <p className="text-sm text-gray-600 mb-1">Link gerado:</p>
        <p className="text-sm font-mono text-blue-600 break-all font-mono bg-blue-50 p-2 rounded">
          {consultationData.consultationUrl}
        </p>
        {consultationData.consultationUrl.includes('null') && (
          <p className="text-red-500 text-xs mt-1">‚ö†Ô∏è URL cont√©m "null"!</p>
        )}
      </div>

      {/* üî¥ SOLU√á√ÉO: Bot√µes de a√ß√£o com teste */}
      <div className="space-y-3">
        <button
          onClick={shareViaWhatsApp}
          className="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          <MessageCircle className="w-4 h-4" />
          Testar no WhatsApp
        </button>

        <button
          onClick={copyLink}
          className="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          {copied ? 'Copiado!' : 'Copiar Link'}
        </button>

        <button
          onClick={testInBrowser}
          className="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          <ExternalLink className="w-4 h-4" />
          Testar no Navegador
        </button>

        {/* üî¥ SOLU√á√ÉO: QR Code com URL v√°lida */}
        {consultationData.qrCode && (
          <div className="mt-4">
            <p className="text-sm text-gray-600 mb-2">Ou escaneie o QR Code:</p>
            <img 
              src={consultationData.qrCode} 
              alt="QR Code da consulta"
              className="w-32 h-32 mx-auto border-2 border-gray-200 rounded-lg"
            />
            <p className="text-xs text-gray-500 text-center mt-2">
              {consultationData.consultationUrl}
            </p>
          </div>
        )}
      </div>

      {/* üî¥ SOLU√á√ÉO: Debug info */}
      <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p className="text-xs text-yellow-800">
          <strong>Debug:</strong> {testUrl || 'Aguardando gera√ß√£o...'}
        </p>
      </div>
    </div>
  );
}
4. Solu√ß√£o para Desenvolvimento Local - ngrok-setup.js
// üî¥ SOLU√á√ÉO: Usar ngrok para testar com HTTPS real
// 1. Instale: npm install -g ngrok
// 2. Execute: ngrok http 3001
// 3. Copie o URL HTTPS fornecido
// 4. Atualize .env.local com: NEXT_PUBLIC_SITE_URL=https://abcd-1234-5678.ngrok.io

// Script auxiliar:
export function getNgrokUrl() {
  // Ler de arquivo tempor√°rio ou environment
  return process.env.NEXT_PUBLIC_NGROK_URL || process.env.NEXT_PUBLIC_SITE_URL;
}
5. Teste de WhatsApp Real - test-whatsapp.js
// üî¥ SOLU√á√ÉO: Testar manualmente com URLs conhecidas
const testUrls = [
  'https://google.com',
  'https://github.com',
  'https://seu-dominio.com/consulta/abc123',
  'https://abcd-1234.ngrok.io/consulta/abc123'
];

// Teste cada URL no WhatsApp
testUrls.forEach(url => {
  const message = `Teste: ${url}`;
  console.log(`Testando: ${message}`);
  // Copie e cole manualmente no WhatsApp
});
üß™ TESTES PARA VERIFICAR
Teste 1: URL V√°lida
# No console do navegador:
await fetch('/api/generate-consultation-token', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({professionalId: 'test123'})
}).then(r => r.json()).then(console.log)
Teste 2: Copiar e Colar Manual
Gerar link com o componente
Copiar com bot√£o "Copiar Link"
Abrir WhatsApp Web
Colar em conversa com algu√©m
Verificar se fica azul/clic√°vel
Teste 3: ngrok (Recomendado)
# Terminal 1:
ngrok http 3001

# Terminal 2:
# Copie o URL HTTPS e atualize .env.local
# Teste novamente
üéØ RESULTADO ESPERADO
‚úÖ URLs sem "null" - Garantido pela valida√ß√£o
‚úÖ HTTPS v√°lido - Usando ngrok ou dom√≠nio real
‚úÖ Links clic√°veis - Com ngrok/HTTPS real
‚úÖ QR Codes v√°lidos - Com URLs corretas
‚úÖ Debug vis√≠vel - Para identificar problemas
A chave √© usar HTTPS real (ngrok) e validar TUDO antes de gerar! üîë