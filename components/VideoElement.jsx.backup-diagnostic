"use client";

import React, { useEffect, useRef } from "react";
import { VideoOff } from "lucide-react";
import { useVideoPanel } from "./VideoPanelContext";

/**
 * Componente de vÃ­deo isolado e otimizado
 * NÃ£o gerencia srcObject diretamente - isso Ã© feito pelo hook centralizado
 */
const VideoElement = () => {
  const { localVideoRef, isCameraPreviewOn, lowPowerMode, isConnected } = useVideoPanel();
  const mountedRef = useRef(false);
  
  const showLocalPreview = isCameraPreviewOn && (!lowPowerMode || isConnected);
  
  // ðŸ”´ GARANTIR QUE COMPONENTE ESTÃ MONTADO
  useEffect(() => {
    mountedRef.current = true;
    
    // Log apenas para debugging (pode ser removido em produÃ§Ã£o)
    if (localVideoRef.current) {
      console.log('âœ… VideoElement montado, ref pronta');
    }
    
    return () => {
      mountedRef.current = false;
      console.log('ðŸ§¹ VideoElement desmontado');
    };
  }, [localVideoRef]);
  
  return (
    <div className="relative w-full h-full">
      <video
        ref={localVideoRef}  // ðŸ”´ REF gerenciada pelo hook centralizado
        autoPlay
        muted
        playsInline
        className="h-full w-full object-cover"
        style={{ 
          opacity: showLocalPreview ? 1 : 0,
          transition: 'opacity 0.2s'
        }}
        // ðŸ”´ EVENTOS REMOVIDOS: Gerenciados pelo hook centralizado
        // Isso elimina conflitos e duplicaÃ§Ã£o de lÃ³gica
      />
      {!showLocalPreview && (
        <div className="absolute inset-0 flex items-center justify-center">
          <VideoOff className="w-12 h-12 text-gray-400" />
        </div>
      )}
    </div>
  );
};

// ðŸ”´ MEMO: Evita re-renders desnecessÃ¡rios
export default React.memo(VideoElement);



