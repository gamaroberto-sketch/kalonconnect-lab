<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste C√¢mera Piscando - KalonConnect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ccc;
            border-radius: 10px;
            background: #000;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
        .info {
            color: #17a2b8;
        }
        .warning {
            color: #ffc107;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste: C√¢mera Piscando - Corre√ß√£o</h1>
        <p>Esta p√°gina testa especificamente o problema da c√¢mera que "pisca e apaga".</p>
        
        <div id="status" class="status inactive">
            üì¥ C√¢mera: DESLIGADA
        </div>
        
        <div>
            <button id="testBtn">üé• Ativar C√¢mera (Teste Robusto)</button>
            <button id="clearBtn">üßπ Limpar Logs</button>
            <button id="stopBtn" disabled>üõë Parar Stream</button>
            <button id="keepAliveBtn" disabled>üõ°Ô∏è For√ßar Keep-Alive</button>
        </div>
        
        <video id="testVideo" autoplay muted playsinline></video>
        
        <div id="logContainer" class="log">
            <div class="info">üìã Logs aparecer√£o aqui...</div>
        </div>
    </div>

    <script>
        const video = document.getElementById('testVideo');
        const testBtn = document.getElementById('testBtn');
        const clearBtn = document.getElementById('clearBtn');
        const stopBtn = document.getElementById('stopBtn');
        const keepAliveBtn = document.getElementById('keepAliveBtn');
        const logContainer = document.getElementById('logContainer');
        const statusDiv = document.getElementById('status');
        
        let currentStream = null;
        let keepAliveInterval = null;
        let streamMonitorInterval = null;
        
        function updateStatus(active, message) {
            if (active) {
                statusDiv.className = 'status active';
                statusDiv.textContent = `üìπ C√¢mera: ATIVA - ${message}`;
            } else {
                statusDiv.className = 'status inactive';
                statusDiv.textContent = `üì¥ C√¢mera: DESLIGADA - ${message}`;
            }
        }
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            logContainer.innerHTML = '<div class="info">üìã Logs limpos...</div>';
        }
        
        function startStreamMonitoring(stream) {
            log('üîç Iniciando monitoramento cont√≠nuo do stream...', 'info');
            
            streamMonitorInterval = setInterval(() => {
                if (stream && stream.active) {
                    const videoTracks = stream.getVideoTracks();
                    const activeTracks = videoTracks.filter(t => t.readyState === 'live');
                    
                    log(`‚úÖ Monitor: Stream ativo (${activeTracks.length}/${videoTracks.length} tracks live)`, 'success');
                    log(`üìê Monitor: V√≠deo ${video.videoWidth}x${video.videoHeight}, paused: ${video.paused}`, 'info');
                    
                    updateStatus(true, `${video.videoWidth}x${video.videoHeight}`);
                    
                    // Verificar se v√≠deo pausou
                    if (video.paused) {
                        log('‚ö†Ô∏è Monitor: V√≠deo pausou, tentando reativar...', 'warning');
                        video.play().catch(error => {
                            log(`‚ùå Monitor: Erro ao reativar: ${error.message}`, 'error');
                        });
                    }
                    
                } else {
                    log('‚ùå Monitor: Stream foi desativado!', 'error');
                    updateStatus(false, 'Stream perdido');
                    clearInterval(streamMonitorInterval);
                    streamMonitorInterval = null;
                }
            }, 2000); // Verificar a cada 2 segundos
        }
        
        function startKeepAlive(stream) {
            log('üõ°Ô∏è Iniciando sistema keep-alive...', 'info');
            
            keepAliveInterval = setInterval(() => {
                if (stream && stream.active) {
                    // For√ßar play se pausou
                    if (video.paused) {
                        log('üîÑ Keep-alive: For√ßando play...', 'warning');
                        video.play();
                    }
                    
                    // Verificar srcObject
                    if (video.srcObject !== stream) {
                        log('üîÑ Keep-alive: Reatribuindo srcObject...', 'warning');
                        video.srcObject = stream;
                    }
                    
                    // Verificar tracks
                    const videoTracks = stream.getVideoTracks();
                    videoTracks.forEach(track => {
                        if (!track.enabled) {
                            log('üîÑ Keep-alive: Reativando track...', 'warning');
                            track.enabled = true;
                        }
                    });
                    
                    log('‚úÖ Keep-alive: Verifica√ß√£o completa', 'success');
                } else {
                    log('‚ùå Keep-alive: Stream perdido, parando...', 'error');
                    clearInterval(keepAliveInterval);
                    keepAliveInterval = null;
                }
            }, 1000); // Keep-alive a cada 1 segundo
        }
        
        async function testRobustCamera() {
            log('üéØ === TESTE ROBUSTO PARA C√ÇMERA PISCANDO ===', 'info');
            
            testBtn.disabled = true;
            updateStatus(false, 'Iniciando...');
            
            try {
                // Teste b√°sico primeiro
                log('üîç Testando acesso b√°sico...', 'info');
                const basicStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                log('‚úÖ Acesso b√°sico OK, aplicando prote√ß√µes...', 'success');
                
                // N√£o parar o stream b√°sico, usar ele mesmo
                currentStream = basicStream;
                
                // Proteger tracks imediatamente
                const videoTracks = basicStream.getVideoTracks();
                videoTracks.forEach((track, index) => {
                    log(`üõ°Ô∏è Protegendo track ${index + 1}: ${track.label}`, 'info');
                    
                    // For√ßar como enabled
                    track.enabled = true;
                    
                    // Listeners para detectar problemas
                    track.addEventListener('ended', () => {
                        log(`‚ùå CR√çTICO: Track ${index + 1} foi TERMINADO!`, 'error');
                        updateStatus(false, 'Track terminado');
                    });
                    
                    track.addEventListener('mute', () => {
                        log(`‚ö†Ô∏è Track ${index + 1} foi MUTADO`, 'warning');
                    });
                    
                    track.addEventListener('unmute', () => {
                        log(`‚úÖ Track ${index + 1} foi DESMUTADO`, 'success');
                    });
                });
                
                // Atribuir ao v√≠deo IMEDIATAMENTE
                log('üîó Atribuindo stream ao v√≠deo...', 'info');
                video.srcObject = basicStream;
                
                // Verificar atribui√ß√£o
                setTimeout(() => {
                    if (video.srcObject === basicStream) {
                        log('‚úÖ srcObject mantido com sucesso!', 'success');
                    } else {
                        log('‚ùå srcObject foi perdido, reatribuindo...', 'error');
                        video.srcObject = basicStream;
                    }
                }, 500);
                
                // Eventos do v√≠deo
                video.onloadedmetadata = () => {
                    log(`üìä Metadados carregados: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    updateStatus(true, `${video.videoWidth}x${video.videoHeight}`);
                };
                
                video.onplaying = () => {
                    log(`üé¨ V√≠deo reproduzindo: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    updateStatus(true, `Reproduzindo ${video.videoWidth}x${video.videoHeight}`);
                };
                
                video.onerror = (event) => {
                    log(`‚ùå Erro no v√≠deo: ${event}`, 'error');
                    updateStatus(false, 'Erro no v√≠deo');
                };
                
                video.onwaiting = () => {
                    log('‚è≥ V√≠deo aguardando dados...', 'warning');
                };
                
                video.onstalled = () => {
                    log('üö´ V√≠deo travado...', 'warning');
                };
                
                // Iniciar monitoramento
                startStreamMonitoring(basicStream);
                
                // Habilitar bot√µes
                stopBtn.disabled = false;
                keepAliveBtn.disabled = false;
                
                log('‚úÖ === TESTE ROBUSTO CONCLU√çDO ===', 'success');
                log('üí° Monitore os logs para ver se a c√¢mera se mant√©m ativa', 'info');
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.name}: ${error.message}`, 'error');
                updateStatus(false, `Erro: ${error.name}`);
                
                if (error.name === 'NotAllowedError') {
                    log('üö´ Permiss√£o negada. Clique no √≠cone da c√¢mera na barra de endere√ßos.', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('üì∑ Nenhuma c√¢mera encontrada.', 'error');
                } else {
                    log('‚ùì Erro desconhecido. Tente reiniciar o navegador.', 'error');
                }
            } finally {
                testBtn.disabled = false;
            }
        }
        
        function stopStream() {
            if (currentStream) {
                log('üõë Parando stream...', 'info');
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    log(`üõë Track ${track.kind} parado`, 'info');
                });
                video.srcObject = null;
                currentStream = null;
                updateStatus(false, 'Parado pelo usu√°rio');
            }
            
            if (streamMonitorInterval) {
                clearInterval(streamMonitorInterval);
                streamMonitorInterval = null;
                log('üõë Monitoramento parado', 'info');
            }
            
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
                log('üõë Keep-alive parado', 'info');
            }
            
            stopBtn.disabled = true;
            keepAliveBtn.disabled = true;
        }
        
        function forceKeepAlive() {
            if (currentStream) {
                if (!keepAliveInterval) {
                    startKeepAlive(currentStream);
                    keepAliveBtn.textContent = 'üõ°Ô∏è Parar Keep-Alive';
                } else {
                    clearInterval(keepAliveInterval);
                    keepAliveInterval = null;
                    keepAliveBtn.textContent = 'üõ°Ô∏è For√ßar Keep-Alive';
                    log('üõë Keep-alive manual parado', 'info');
                }
            }
        }
        
        testBtn.addEventListener('click', testRobustCamera);
        clearBtn.addEventListener('click', clearLogs);
        stopBtn.addEventListener('click', stopStream);
        keepAliveBtn.addEventListener('click', forceKeepAlive);
        
        // Log inicial
        log('üîß P√°gina de corre√ß√£o carregada. Clique em "Ativar C√¢mera" para testar.', 'info');
        updateStatus(false, 'Aguardando teste');
    </script>
</body>
</html>


