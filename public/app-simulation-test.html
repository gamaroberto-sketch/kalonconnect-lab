<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simula√ß√£o App Principal - KalonConnect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.active {
            background: #28a745;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Simula√ß√£o: App Principal - Teste C√¢mera</h1>
        <p>Esta p√°gina simula exatamente o comportamento da aplica√ß√£o principal com m√∫ltiplos componentes.</p>
        
        <div id="status" class="status inactive">
            üì¥ C√¢mera: DESLIGADA
        </div>
        
        <div class="controls">
            <button id="cameraBtn">üìπ Ligar/Desligar C√¢mera</button>
            <button id="videoBtn" disabled>üé• Ligar/Desligar V√≠deo</button>
            <button id="audioBtn" disabled>üé§ Ligar/Desligar √Åudio</button>
            <button id="multipleBtn">‚ö° M√∫ltiplas Chamadas (Teste Stress)</button>
            <button id="clearBtn">üßπ Limpar Logs</button>
            <button id="stopBtn" disabled>üõë Parar Tudo</button>
        </div>
        
        <div class="video-container">
            <video id="mainVideo" autoplay muted playsinline></video>
        </div>
        
        <div id="logContainer" class="log">
            <div class="info">üìã Logs da simula√ß√£o aparecer√£o aqui...</div>
        </div>
    </div>

    <script>
        // Simula√ß√£o das vari√°veis globais da aplica√ß√£o
        let currentStream = null;
        let isCameraPreviewOn = false;
        let isVideoOn = false;
        let isAudioOn = false;
        let streamMonitorInterval = null;
        
        // Elementos DOM
        const video = document.getElementById('mainVideo');
        const cameraBtn = document.getElementById('cameraBtn');
        const videoBtn = document.getElementById('videoBtn');
        const audioBtn = document.getElementById('audioBtn');
        const multipleBtn = document.getElementById('multipleBtn');
        const clearBtn = document.getElementById('clearBtn');
        const stopBtn = document.getElementById('stopBtn');
        const logContainer = document.getElementById('logContainer');
        const statusDiv = document.getElementById('status');
        
        // Flags de prote√ß√£o (simulando window.kalon*)
        window.kalonEnsureStreamInProgress = false;
        window.kalonToggleCameraInProgress = false;
        
        function updateStatus(active, message) {
            if (active) {
                statusDiv.className = 'status active';
                statusDiv.textContent = `üìπ C√¢mera: ATIVA - ${message}`;
            } else {
                statusDiv.className = 'status inactive';
                statusDiv.textContent = `üì¥ C√¢mera: DESLIGADA - ${message}`;
            }
        }
        
        function updateButtons() {
            cameraBtn.textContent = isCameraPreviewOn ? 'üìπ Desligar C√¢mera' : 'üìπ Ligar C√¢mera';
            cameraBtn.className = isCameraPreviewOn ? 'active' : '';
            
            videoBtn.textContent = isVideoOn ? 'üé• Desligar V√≠deo' : 'üé• Ligar V√≠deo';
            videoBtn.className = isVideoOn ? 'active' : '';
            videoBtn.disabled = !currentStream;
            
            audioBtn.textContent = isAudioOn ? 'üé§ Desligar √Åudio' : 'üé§ Ligar √Åudio';
            audioBtn.className = isAudioOn ? 'active' : '';
            audioBtn.disabled = !currentStream;
            
            stopBtn.disabled = !currentStream;
        }
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            logContainer.innerHTML = '<div class="info">üìã Logs limpos...</div>';
        }
        
        // Simula√ß√£o do createMediaStream com todas as prote√ß√µes
        async function createMediaStream(constraints = { video: true, audio: true }) {
            log('üéØ === INICIANDO TESTE COMPLETO DE CONSTRAINTS ===', 'info');
            
            // Prote√ß√£o contra m√∫ltiplas chamadas
            if (window.kalonCreateStreamInProgress) {
                log('‚ö†Ô∏è createMediaStream j√° em progresso, aguardando...', 'warning');
                let attempts = 0;
                while (window.kalonCreateStreamInProgress && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                log(`‚úÖ Chamada anterior conclu√≠da ap√≥s ${attempts * 100}ms`, 'success');
                return currentStream;
            }
            
            window.kalonCreateStreamInProgress = true;
            
            try {
                // Constraints de teste (vers√£o simplificada)
                const testConstraints = [
                    { name: 'B√°sico', constraints: { video: true, audio: true } },
                    { name: 'S√≥ V√≠deo', constraints: { video: true, audio: false } },
                    { name: 'HD', constraints: { video: { width: 1280, height: 720 }, audio: false } },
                    { name: 'VGA', constraints: { video: { width: 640, height: 480 }, audio: false } }
                ];
                
                let successfulStream = null;
                
                for (const test of testConstraints) {
                    try {
                        log(`üîÑ TESTANDO: ${test.name}`, 'info');
                        
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout ap√≥s 10 segundos')), 10000)
                        );
                        
                        const streamPromise = navigator.mediaDevices.getUserMedia(test.constraints);
                        const stream = await Promise.race([streamPromise, timeoutPromise]);
                        
                        log(`‚úÖ SUCESSO: ${test.name}`, 'success');
                        
                        // Proteger o stream principal
                        if (!successfulStream) {
                            successfulStream = stream;
                            log(`üéØ USANDO: ${test.name} como stream principal`, 'success');
                            
                            // Proteger tracks
                            stream.getVideoTracks().forEach(track => {
                                track.enabled = true;
                                log(`üõ°Ô∏è Track protegido: ${track.label}`, 'info');
                                
                                track.addEventListener('ended', () => {
                                    log('‚ùå CR√çTICO: Track terminado inesperadamente!', 'error');
                                });
                            });
                            
                        } else {
                            // Parar streams de teste
                            stream.getTracks().forEach(track => track.stop());
                            log(`üõë Stream de teste ${test.name} parado`, 'info');
                        }
                        
                        break; // Usar primeiro sucesso
                        
                    } catch (error) {
                        log(`‚ùå FALHOU: ${test.name} - ${error.message}`, 'error');
                        
                        if (error.name === 'NotAllowedError') {
                            log('üö´ ERRO FATAL: Permiss√£o negada', 'error');
                            break;
                        }
                    }
                }
                
                if (successfulStream) {
                    log('‚úÖ Stream criado com sucesso!', 'success');
                    return successfulStream;
                } else {
                    log('‚ùå Todos os testes falharam', 'error');
                    return null;
                }
                
            } finally {
                window.kalonCreateStreamInProgress = false;
            }
        }
        
        // Simula√ß√£o do assignStreamToVideo
        async function assignStreamToVideo(stream) {
            log('üîó === ATRIBUINDO STREAM AO V√çDEO ===', 'info');
            
            if (!stream || !stream.active) {
                log('‚ùå Stream inv√°lido ou inativo', 'error');
                return false;
            }
            
            // Verificar tracks
            const videoTracks = stream.getVideoTracks();
            const activeTracks = videoTracks.filter(t => t.readyState === 'live');
            
            if (activeTracks.length === 0) {
                log('‚ùå Nenhum track de v√≠deo ativo', 'error');
                return false;
            }
            
            log(`‚úÖ ${activeTracks.length} tracks ativos encontrados`, 'success');
            
            // Atribuir ao v√≠deo
            video.srcObject = stream;
            log('üéØ srcObject atribu√≠do', 'info');
            
            // Verificar se "colou"
            setTimeout(() => {
                if (video.srcObject === stream) {
                    log('‚úÖ srcObject mantido com sucesso', 'success');
                } else {
                    log('‚ùå srcObject foi perdido, reatribuindo...', 'error');
                    video.srcObject = stream;
                }
            }, 1000);
            
            // Eventos do v√≠deo
            video.onloadedmetadata = () => {
                log(`üìä Metadados: ${video.videoWidth}x${video.videoHeight}`, 'success');
                updateStatus(true, `${video.videoWidth}x${video.videoHeight}`);
            };
            
            video.onplaying = () => {
                log(`üé¨ Reproduzindo: ${video.videoWidth}x${video.videoHeight}`, 'success');
            };
            
            return true;
        }
        
        // Simula√ß√£o do ensureLocalStream
        async function ensureLocalStream() {
            log('üéØ === INICIANDO ensureLocalStream ===', 'info');
            
            // Prote√ß√£o contra m√∫ltiplas chamadas
            if (window.kalonEnsureStreamInProgress) {
                log('‚ö†Ô∏è ensureLocalStream j√° em progresso, aguardando...', 'warning');
                let attempts = 0;
                while (window.kalonEnsureStreamInProgress && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                log(`‚úÖ Chamada anterior conclu√≠da ap√≥s ${attempts * 100}ms`, 'success');
                return currentStream;
            }
            
            window.kalonEnsureStreamInProgress = true;
            
            try {
                // Verificar stream existente
                if (currentStream && currentStream.active) {
                    log('‚úÖ Stream j√° existe e est√° ativo', 'success');
                    return currentStream;
                }
                
                // Criar novo stream
                const stream = await createMediaStream({ video: true, audio: true });
                
                if (!stream) {
                    log('‚ùå Falha ao criar stream', 'error');
                    return null;
                }
                
                // Atribuir ao v√≠deo
                const success = await assignStreamToVideo(stream);
                
                if (success) {
                    currentStream = stream;
                    log('‚úÖ ensureLocalStream CONCLU√çDO COM SUCESSO', 'success');
                    
                    // Iniciar monitoramento
                    startStreamMonitoring();
                    
                    return stream;
                } else {
                    log('‚ùå Falha na atribui√ß√£o, parando stream', 'error');
                    stream.getTracks().forEach(track => track.stop());
                    return null;
                }
                
            } catch (error) {
                log(`‚ùå ERRO em ensureLocalStream: ${error.message}`, 'error');
                return null;
            } finally {
                window.kalonEnsureStreamInProgress = false;
                log('üßπ ensureLocalStream finalizado', 'info');
            }
        }
        
        // Simula√ß√£o do toggleCameraPreview
        async function toggleCameraPreview() {
            log('üéØ toggleCameraPreview chamado', 'info');
            
            // Prote√ß√£o contra m√∫ltiplas chamadas
            if (window.kalonToggleCameraInProgress) {
                log('‚ö†Ô∏è toggleCameraPreview j√° em progresso, ignorando...', 'warning');
                return;
            }
            
            window.kalonToggleCameraInProgress = true;
            
            try {
                if (isCameraPreviewOn) {
                    // Desligar c√¢mera
                    log('üì¥ Desligando c√¢mera...', 'info');
                    
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                    }
                    
                    video.srcObject = null;
                    isCameraPreviewOn = false;
                    isVideoOn = false;
                    
                    if (streamMonitorInterval) {
                        clearInterval(streamMonitorInterval);
                        streamMonitorInterval = null;
                    }
                    
                    updateStatus(false, 'Desligada pelo usu√°rio');
                    log('‚úÖ C√¢mera desligada', 'success');
                    
                } else {
                    // Ligar c√¢mera
                    log('üìπ Ligando c√¢mera...', 'info');
                    
                    const stream = await ensureLocalStream();
                    
                    if (stream) {
                        // Habilitar tracks
                        stream.getVideoTracks().forEach(track => {
                            track.enabled = true;
                            log(`‚úÖ Track habilitado: ${track.label}`, 'success');
                        });
                        
                        isCameraPreviewOn = true;
                        isVideoOn = true;
                        log('‚úÖ C√¢mera ligada com sucesso', 'success');
                    } else {
                        log('‚ùå Falha ao ligar c√¢mera', 'error');
                    }
                }
                
                updateButtons();
                
            } catch (error) {
                log(`‚ùå ERRO em toggleCameraPreview: ${error.message}`, 'error');
            } finally {
                window.kalonToggleCameraInProgress = false;
                log('üßπ toggleCameraPreview finalizado', 'info');
            }
        }
        
        function startStreamMonitoring() {
            if (streamMonitorInterval) return;
            
            log('üîç Iniciando monitoramento do stream...', 'info');
            
            streamMonitorInterval = setInterval(() => {
                if (currentStream && currentStream.active) {
                    const videoTracks = currentStream.getVideoTracks();
                    const activeTracks = videoTracks.filter(t => t.readyState === 'live');
                    
                    log(`‚úÖ Monitor: ${activeTracks.length}/${videoTracks.length} tracks ativos`, 'success');
                    
                    if (video.paused) {
                        log('‚ö†Ô∏è V√≠deo pausou, reativando...', 'warning');
                        video.play();
                    }
                    
                } else {
                    log('‚ùå Monitor: Stream perdido!', 'error');
                    updateStatus(false, 'Stream perdido');
                    clearInterval(streamMonitorInterval);
                    streamMonitorInterval = null;
                }
            }, 3000);
        }
        
        // Teste de m√∫ltiplas chamadas simult√¢neas
        async function testMultipleCalls() {
            log('‚ö° === TESTE DE STRESS: M√öLTIPLAS CHAMADAS ===', 'warning');
            
            // Simular m√∫ltiplos cliques r√°pidos
            const promises = [];
            for (let i = 0; i < 5; i++) {
                promises.push(toggleCameraPreview());
                log(`üîÑ Chamada ${i + 1} disparada`, 'info');
            }
            
            try {
                await Promise.all(promises);
                log('‚úÖ Teste de stress conclu√≠do', 'success');
            } catch (error) {
                log(`‚ùå Erro no teste de stress: ${error.message}`, 'error');
            }
        }
        
        function stopEverything() {
            log('üõë Parando tudo...', 'info');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            video.srcObject = null;
            isCameraPreviewOn = false;
            isVideoOn = false;
            isAudioOn = false;
            
            if (streamMonitorInterval) {
                clearInterval(streamMonitorInterval);
                streamMonitorInterval = null;
            }
            
            // Limpar flags
            window.kalonEnsureStreamInProgress = false;
            window.kalonToggleCameraInProgress = false;
            window.kalonCreateStreamInProgress = false;
            
            updateStatus(false, 'Parado');
            updateButtons();
            log('‚úÖ Tudo parado', 'success');
        }
        
        // Event listeners
        cameraBtn.addEventListener('click', toggleCameraPreview);
        multipleBtn.addEventListener('click', testMultipleCalls);
        clearBtn.addEventListener('click', clearLogs);
        stopBtn.addEventListener('click', stopEverything);
        
        // Inicializa√ß√£o
        updateButtons();
        updateStatus(false, 'Aguardando');
        log('üéØ Simula√ß√£o da aplica√ß√£o principal carregada', 'info');
        log('üí° Clique em "Ligar C√¢mera" para testar o comportamento real', 'info');
    </script>
</body>
</html>


