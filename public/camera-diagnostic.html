<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de C√¢mera - Kalonos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.pending { background: #ffc107; color: #000; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.info { background: #17a2b8; color: white; }
        
        video {
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: #000;
            border-radius: 12px;
            margin: 15px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { background: #5568d3; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-line {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-line.error { border-left-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
        .log-line.success { border-left-color: #28a745; background: rgba(40, 167, 69, 0.1); }
        .log-line.info { border-left-color: #17a2b8; background: rgba(23, 162, 184, 0.1); }
        
        .device-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .device-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-item:last-child { border-bottom: none; }
        
        .recommendation {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .recommendation h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .recommendation ul {
            margin-left: 20px;
            color: #856404;
        }
        .recommendation li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de C√¢mera</h1>
        <p class="subtitle">Ferramenta de diagn√≥stico para identificar bloqueios de hardware</p>

        <!-- Teste 1: Permiss√µes -->
        <div class="test-section">
            <h2>
                <span id="status1" class="status pending">AGUARDANDO</span>
                Teste 1: Verificar Permiss√µes
            </h2>
            <button onclick="testPermissions()">Iniciar Teste de Permiss√µes</button>
            <div id="log1" class="log" style="display:none;"></div>
        </div>

        <!-- Teste 2: Listar Dispositivos -->
        <div class="test-section">
            <h2>
                <span id="status2" class="status pending">AGUARDANDO</span>
                Teste 2: Listar C√¢meras Dispon√≠veis
            </h2>
            <button onclick="listDevices()">Listar Dispositivos</button>
            <div id="devices" class="device-list" style="display:none;"></div>
            <div id="log2" class="log" style="display:none;"></div>
        </div>

        <!-- Teste 3: Acesso Direto -->
        <div class="test-section">
            <h2>
                <span id="status3" class="status pending">AGUARDANDO</span>
                Teste 3: Acesso Direto √† C√¢mera
            </h2>
            <button onclick="testDirectAccess()">Testar Acesso Direto</button>
            <video id="video" autoplay muted playsinline style="display:none;"></video>
            <div id="log3" class="log" style="display:none;"></div>
        </div>

        <!-- Teste 4: Teste com Cada Dispositivo -->
        <div class="test-section">
            <h2>
                <span id="status4" class="status pending">AGUARDANDO</span>
                Teste 4: Testar Cada C√¢mera Individualmente
            </h2>
            <button onclick="testEachDevice()">Testar Todas as C√¢meras</button>
            <div id="log4" class="log" style="display:none;"></div>
        </div>

        <!-- Recomenda√ß√µes -->
        <div id="recommendations" style="display:none;"></div>
    </div>

    <script>
        let allDevices = [];
        
        function log(sectionId, message, type = 'info') {
            const logEl = document.getElementById(`log${sectionId}`);
            logEl.style.display = 'block';
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStatus(sectionId, status, text) {
            const statusEl = document.getElementById(`status${sectionId}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = text;
        }

        async function testPermissions() {
            log(1, 'Verificando permiss√µes do navegador...', 'info');
            setStatus(1, 'pending', 'TESTANDO');
            
            try {
                const result = await navigator.permissions.query({ name: 'camera' });
                log(1, `Permiss√£o de c√¢mera: ${result.state}`, result.state === 'granted' ? 'success' : 'error');
                
                if (result.state === 'granted') {
                    setStatus(1, 'success', '‚úÖ PERMITIDO');
                    log(1, 'C√¢mera tem permiss√£o do navegador', 'success');
                } else if (result.state === 'prompt') {
                    setStatus(1, 'info', 'PRECISA AUTORIZAR');
                    log(1, 'Navegador vai pedir permiss√£o ao acessar c√¢mera', 'info');
                } else {
                    setStatus(1, 'error', '‚ùå BLOQUEADO');
                    log(1, 'PROBLEMA: Permiss√£o de c√¢mera foi negada!', 'error');
                    showRecommendation('permission');
                }
            } catch (error) {
                log(1, `Erro ao verificar permiss√µes: ${error.message}`, 'error');
                setStatus(1, 'error', '‚ùå ERRO');
            }
        }

        async function listDevices() {
            log(2, 'Listando dispositivos de m√≠dia...', 'info');
            setStatus(2, 'pending', 'LISTANDO');
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                allDevices = videoDevices;
                
                log(2, `Encontradas ${videoDevices.length} c√¢mera(s)`, 'success');
                
                const devicesEl = document.getElementById('devices');
                devicesEl.style.display = 'block';
                devicesEl.innerHTML = '<h3 style="margin-bottom:10px;">C√¢meras Detectadas:</h3>';
                
                videoDevices.forEach((device, index) => {
                    const div = document.createElement('div');
                    div.className = 'device-item';
                    div.innerHTML = `
                        <div>
                            <strong>${device.label || `C√¢mera ${index + 1}`}</strong><br>
                            <small style="color:#666;">ID: ${device.deviceId.substring(0, 20)}...</small>
                        </div>
                        <span class="status info">DETECTADA</span>
                    `;
                    devicesEl.appendChild(div);
                    log(2, `üìπ ${device.label || `C√¢mera ${index + 1}`}`, 'info');
                });
                
                setStatus(2, 'success', `‚úÖ ${videoDevices.length} C√ÇMERA(S)`);
                
                if (videoDevices.length === 0) {
                    log(2, 'PROBLEMA: Nenhuma c√¢mera detectada!', 'error');
                    showRecommendation('no-devices');
                }
            } catch (error) {
                log(2, `Erro ao listar dispositivos: ${error.message}`, 'error');
                setStatus(2, 'error', '‚ùå ERRO');
            }
        }

        async function testDirectAccess() {
            log(3, 'Tentando acesso direto √† c√¢mera...', 'info');
            setStatus(3, 'pending', 'TESTANDO');
            
            const video = document.getElementById('video');
            
            try {
                log(3, 'Chamando getUserMedia...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: false
                });
                
                log(3, '‚úÖ Stream obtido com sucesso!', 'success');
                log(3, `Tracks: ${stream.getVideoTracks().length} v√≠deo`, 'success');
                
                video.style.display = 'block';
                video.srcObject = stream;
                
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                log(3, `Resolu√ß√£o: ${settings.width}x${settings.height}`, 'info');
                log(3, `Device: ${settings.deviceId}`, 'info');
                
                setStatus(3, 'success', '‚úÖ FUNCIONANDO');
                log(3, 'C√ÇMERA EST√Å FUNCIONANDO PERFEITAMENTE!', 'success');
                
            } catch (error) {
                log(3, `‚ùå ERRO: ${error.name}`, 'error');
                log(3, `Mensagem: ${error.message}`, 'error');
                setStatus(3, 'error', '‚ùå FALHOU');
                
                if (error.name === 'NotReadableError') {
                    log(3, 'DIAGN√ìSTICO: C√¢mera est√° sendo usada por outro processo!', 'error');
                    showRecommendation('not-readable');
                } else if (error.name === 'NotAllowedError') {
                    log(3, 'DIAGN√ìSTICO: Permiss√£o negada pelo usu√°rio!', 'error');
                    showRecommendation('not-allowed');
                } else if (error.name === 'NotFoundError') {
                    log(3, 'DIAGN√ìSTICO: Nenhuma c√¢mera encontrada!', 'error');
                    showRecommendation('not-found');
                }
            }
        }

        async function testEachDevice() {
            if (allDevices.length === 0) {
                log(4, 'Execute o Teste 2 primeiro para listar dispositivos', 'error');
                return;
            }
            
            log(4, `Testando ${allDevices.length} dispositivo(s)...`, 'info');
            setStatus(4, 'pending', 'TESTANDO');
            
            let successCount = 0;
            
            for (let i = 0; i < allDevices.length; i++) {
                const device = allDevices[i];
                log(4, `\nTestando: ${device.label || `C√¢mera ${i + 1}`}`, 'info');
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: device.deviceId } }
                    });
                    
                    log(4, `‚úÖ ${device.label}: FUNCIONANDO`, 'success');
                    successCount++;
                    
                    // Parar stream
                    stream.getTracks().forEach(track => track.stop());
                    
                } catch (error) {
                    log(4, `‚ùå ${device.label}: ${error.name}`, 'error');
                    log(4, `   Motivo: ${error.message}`, 'error');
                }
            }
            
            if (successCount === allDevices.length) {
                setStatus(4, 'success', '‚úÖ TODAS OK');
                log(4, '\nüéâ TODAS AS C√ÇMERAS FUNCIONAM!', 'success');
            } else if (successCount > 0) {
                setStatus(4, 'info', `‚ö†Ô∏è ${successCount}/${allDevices.length} OK`);
                log(4, `\n‚ö†Ô∏è Apenas ${successCount} de ${allDevices.length} c√¢meras funcionam`, 'info');
            } else {
                setStatus(4, 'error', '‚ùå NENHUMA OK');
                log(4, '\n‚ùå NENHUMA C√ÇMERA FUNCIONA', 'error');
                showRecommendation('all-failed');
            }
        }

        function showRecommendation(type) {
            const recEl = document.getElementById('recommendations');
            recEl.style.display = 'block';
            
            const recommendations = {
                'permission': {
                    title: 'üîí Problema de Permiss√£o',
                    items: [
                        'Clique no √≠cone de cadeado na barra de endere√ßo',
                        'Certifique-se que "C√¢mera" est√° definida como "Permitir"',
                        'Recarregue a p√°gina ap√≥s alterar'
                    ]
                },
                'not-readable': {
                    title: '‚ö†Ô∏è C√¢mera em Uso por Outro Processo',
                    items: [
                        'Feche TODOS os outros programas que usam c√¢mera (Zoom, Teams, Skype, etc.)',
                        'Feche TODAS as abas do navegador',
                        'Abra o Gerenciador de Tarefas e finalize processos da Logitech',
                        'Reinicie o computador',
                        'Teste novamente'
                    ]
                },
                'not-allowed': {
                    title: 'üö´ Permiss√£o Negada',
                    items: [
                        'Voc√™ clicou em "Bloquear" quando o navegador pediu permiss√£o',
                        'V√° em Configura√ß√µes do Chrome ‚Üí Privacidade ‚Üí C√¢mera',
                        'Remova este site da lista de bloqueados',
                        'Recarregue e aceite a permiss√£o'
                    ]
                },
                'all-failed': {
                    title: 'üí• Problema Cr√≠tico de Hardware/Driver',
                    items: [
                        'Desinstale o driver da c√¢mera no Gerenciador de Dispositivos',
                        'Desconecte a c√¢mera fisicamente (USB)',
                        'Reinicie o PC',
                        'Reconecte a c√¢mera',
                        'Deixe o Windows instalar o driver gen√©rico',
                        'N√ÉO instale o Logitech Capture'
                    ]
                }
            };
            
            const rec = recommendations[type];
            if (rec) {
                recEl.innerHTML = `
                    <div class="recommendation">
                        <h3>${rec.title}</h3>
                        <ul>
                            ${rec.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
